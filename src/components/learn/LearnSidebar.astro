---
import { buildNavTree, getCourseMeta, type NavItem } from '~/utils/learn'

interface Props {
  course: string
  currentPath: string
}

const { course, currentPath } = Astro.props
const courseMeta = getCourseMeta(course)
const navTree = await buildNavTree(course)

function isActive(href: string): boolean {
  return currentPath === href
}

function isParentOfCurrent(item: NavItem): boolean {
  if (isActive(item.href)) return true
  if (item.children) {
    return item.children.some((child) => isParentOfCurrent(child))
  }
  return false
}
---

<div class="px-4">
  <!-- Course Title -->
  <a
    href={`/learn/${course}`}
    class="block text-sm font-semibold text-stone-900 dark:text-stone-100 mb-4 hover:text-stone-600 dark:hover:text-stone-400 transition-colors"
  >
    {courseMeta?.title || course}
  </a>

  <!-- Navigation Tree -->
  <ul class="space-y-1">
    {navTree.map((item) => (
      <li>
        <a
          href={item.href}
          class:list={[
            'block py-1.5 text-sm transition-colors',
            isActive(item.href)
              ? 'text-stone-900 dark:text-stone-100 font-medium'
              : 'text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100',
          ]}
        >
          {item.title}
        </a>

        {item.children && item.children.length > 0 && (
          <ul class:list={['pl-4 space-y-1', isParentOfCurrent(item) ? '' : 'hidden lg:block']}>
            {item.children.map((child) => (
              <li>
                <a
                  href={child.href}
                  class:list={[
                    'block py-1 text-sm transition-colors',
                    isActive(child.href)
                      ? 'text-stone-900 dark:text-stone-100 font-medium'
                      : 'text-stone-500 dark:text-stone-500 hover:text-stone-900 dark:hover:text-stone-100',
                  ]}
                >
                  {child.title}
                </a>

                {child.children && child.children.length > 0 && (
                  <ul class:list={['pl-4 space-y-1', isParentOfCurrent(child) ? '' : 'hidden']}>
                    {child.children.map((grandchild) => (
                      <li>
                        <a
                          href={grandchild.href}
                          class:list={[
                            'block py-1 text-xs transition-colors',
                            isActive(grandchild.href)
                              ? 'text-stone-900 dark:text-stone-100 font-medium'
                              : 'text-stone-500 dark:text-stone-500 hover:text-stone-900 dark:hover:text-stone-100',
                          ]}
                        >
                          {grandchild.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                )}
              </li>
            ))}
          </ul>
        )}
      </li>
    ))}
  </ul>
</div>
