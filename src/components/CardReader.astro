---
---

<div id="card-reader" class="card-reader">
  <!-- 背景遮罩 -->
  <div class="card-reader-backdrop"></div>

  <!-- 內容區 -->
  <div class="card-reader-container">
    <!-- 關閉按鈕 -->
    <button class="card-reader-close" aria-label="關閉卡片模式">
      <span class="i-mdi-close text-xl"></span>
    </button>

    <!-- 主 Slider 容器 -->
    <div id="card-slider" class="keen-slider card-slider">
      <!-- JS 動態產生卡片 -->
    </div>

    <!-- 導航按鈕 (電腦版) -->
    <button class="card-nav card-nav-prev" aria-label="上一張">
      <span class="i-mdi-chevron-left text-2xl"></span>
    </button>
    <button class="card-nav card-nav-next" aria-label="下一張">
      <span class="i-mdi-chevron-right text-2xl"></span>
    </button>

    <!-- 進度圓點 -->
    <div class="card-reader-dots"></div>
  </div>
</div>

<script>
  import KeenSlider from 'keen-slider'
  import type { KeenSliderInstance } from 'keen-slider'

  interface CardReaderState {
    isOpen: boolean
    currentIndex: number
    totalCards: number
    isDesktop: boolean
  }

  function initCardReader() {
    const reader = document.getElementById('card-reader')
    if (!reader) return

    const backdrop = reader.querySelector('.card-reader-backdrop')
    const sliderContainer = reader.querySelector('#card-slider') as HTMLElement
    const dotsContainer = reader.querySelector('.card-reader-dots') as HTMLElement
    const closeBtn = reader.querySelector('.card-reader-close')
    const prevBtn = reader.querySelector('.card-nav-prev') as HTMLButtonElement
    const nextBtn = reader.querySelector('.card-nav-next') as HTMLButtonElement

    if (!sliderContainer || !dotsContainer) return

    let mainSlider: KeenSliderInstance | null = null
    let innerSlidersMap: Map<string, KeenSliderInstance> = new Map()

    const state: CardReaderState = {
      isOpen: false,
      currentIndex: 0,
      totalCards: 0,
      isDesktop: window.matchMedia('(min-width: 768px)').matches
    }

    const mediaQuery = window.matchMedia('(min-width: 768px)')

    // 解析 HTML，用 h3 分割成子區塊
    function splitByH3(html: string): string[] {
      const h3Pattern = /<h3[^>]*>/gi
      const matches: number[] = []
      let match

      while ((match = h3Pattern.exec(html)) !== null) {
        matches.push(match.index)
      }

      if (matches.length === 0) {
        return [html]
      }

      const sections: string[] = []

      // h3 之前的內容
      if (matches[0] > 0) {
        const firstPart = html.substring(0, matches[0]).trim()
        if (firstPart) {
          sections.push(firstPart)
        }
      }

      // 依照 h3 分割
      for (let i = 0; i < matches.length; i++) {
        const start = matches[i]
        const end = matches[i + 1] ?? html.length
        const section = html.substring(start, end).trim()
        if (section) {
          sections.push(section)
        }
      }

      return sections
    }

    // 開啟 CardReader
    function open(htmlContent: string) {
      // 用 <hr> 分割成主卡片
      const mainSections = htmlContent.split(/<hr\s*\/?>/i).filter(s => s.trim())

      if (mainSections.length === 0) return

      // 清空
      sliderContainer.innerHTML = ''
      dotsContainer.innerHTML = ''
      innerSlidersMap.clear()

      // 記錄哪些 slide 有內層 slider
      const innerSliderConfigs: { containerId: string; sections: string[] }[] = []

      mainSections.forEach((sectionHtml, index) => {
        // 建立主卡片
        const slide = document.createElement('div')
        slide.className = 'keen-slider__slide main-slide'
        slide.setAttribute('data-slide-index', String(index))

        // 檢查是否有 h3
        const subSections = splitByH3(sectionHtml)

        if (subSections.length > 1) {
          // 有多個子區塊，建立內層 slider 結構
          const innerContainer = document.createElement('div')
          innerContainer.className = 'inner-slider-wrapper'

          const innerId = `inner-slider-${index}`
          const innerSliderEl = document.createElement('div')
          innerSliderEl.id = innerId
          innerSliderEl.className = 'keen-slider inner-slider'

          subSections.forEach((subHtml, subIdx) => {
            const innerSlide = document.createElement('div')
            innerSlide.className = 'keen-slider__slide inner-slide'

            const content = document.createElement('div')
            content.className = 'inner-slide-content prose prose-stone dark:prose-invert max-w-none'
            content.innerHTML = subHtml

            innerSlide.appendChild(content)
            innerSliderEl.appendChild(innerSlide)
          })

          // 內層圓點
          const innerDots = document.createElement('div')
          innerDots.className = 'inner-slider-dots'
          innerDots.id = `inner-dots-${index}`

          subSections.forEach((_, subIdx) => {
            const dot = document.createElement('button')
            dot.className = 'inner-dot'
            dot.setAttribute('data-index', String(subIdx))
            innerDots.appendChild(dot)
          })

          innerContainer.appendChild(innerSliderEl)
          innerContainer.appendChild(innerDots)
          slide.appendChild(innerContainer)

          // 記錄要初始化的內層 slider
          innerSliderConfigs.push({ containerId: innerId, sections: subSections })
        } else {
          // 只有一個區塊，直接顯示（可滾動）
          const card = document.createElement('div')
          card.className = 'card-content prose prose-stone dark:prose-invert max-w-none'
          card.innerHTML = sectionHtml.trim()
          slide.appendChild(card)
        }

        sliderContainer.appendChild(slide)

        // 主圓點
        const dot = document.createElement('button')
        dot.className = 'card-reader-dot'
        dot.setAttribute('data-index', String(index))
        dotsContainer.appendChild(dot)
      })

      state.totalCards = mainSections.length
      state.currentIndex = 0
      state.isOpen = true

      // 顯示 reader
      reader!.classList.add('is-open')
      document.body.style.overflow = 'hidden'

      // 初始化主 Slider - 關鍵：使用 selector 只選主層的 slides
      mainSlider = new KeenSlider(sliderContainer, {
        selector: '.main-slide',
        slides: {
          perView: 1,
          spacing: 16
        },
        rubberband: false,
        created: () => {
          updateMainDots()
          updateNavButtons()
        },
        slideChanged: (s) => {
          state.currentIndex = s.track.details.rel
          updateMainDots()
          updateNavButtons()
        }
      })

      // 初始化所有內層 Sliders
      innerSliderConfigs.forEach(({ containerId, sections }, idx) => {
        const el = document.getElementById(containerId)
        const dotsEl = document.getElementById(`inner-dots-${containerId.split('-')[2]}`)

        if (el) {
          const innerSlider = new KeenSlider(el, {
            vertical: state.isDesktop,
            slides: {
              perView: 1,
              spacing: 0
            },
            rubberband: false,
            created: (s) => {
              updateInnerDots(dotsEl, 0)
            },
            slideChanged: (s) => {
              updateInnerDots(dotsEl, s.track.details.rel)
            }
          })

          // 內層圓點點擊
          if (dotsEl) {
            const dots = dotsEl.querySelectorAll('.inner-dot')
            dots.forEach((dot, dotIdx) => {
              dot.addEventListener('click', () => {
                innerSlider.moveToIdx(dotIdx)
              })
            })
          }

          // 用 ID 作為 key 存入 Map
          innerSlidersMap.set(containerId, innerSlider)
        }
      })

      // 主圓點點擊
      const mainDots = dotsContainer.querySelectorAll('.card-reader-dot')
      mainDots.forEach((dot, idx) => {
        dot.addEventListener('click', () => {
          mainSlider?.moveToIdx(idx)
        })
      })

      // 監聽鍵盤
      document.addEventListener('keydown', handleKeydown)
    }

    // 關閉 CardReader
    function close() {
      if (!state.isOpen) return
      state.isOpen = false
      reader!.classList.remove('is-open')
      document.removeEventListener('keydown', handleKeydown)

      // 等待淡出動畫結束後再銷毀 slider 和清空內容
      setTimeout(() => {
        // 銷毀所有 slider
        innerSlidersMap.forEach(s => s.destroy())
        innerSlidersMap.clear()

        if (mainSlider) {
          mainSlider.destroy()
          mainSlider = null
        }

        document.body.style.overflow = ''
        sliderContainer.innerHTML = ''
        dotsContainer.innerHTML = ''
      }, 300)
    }

    // 更新主圓點
    function updateMainDots() {
      const dots = dotsContainer.querySelectorAll('.card-reader-dot')
      dots.forEach((dot, index) => {
        dot.classList.toggle('is-active', index === state.currentIndex)
      })
    }

    // 更新內層圓點
    function updateInnerDots(container: Element | null, activeIndex: number) {
      if (!container) return
      const dots = container.querySelectorAll('.inner-dot')
      dots.forEach((dot, index) => {
        dot.classList.toggle('is-active', index === activeIndex)
      })
    }

    // 更新導航按鈕
    function updateNavButtons() {
      if (prevBtn) prevBtn.disabled = state.currentIndex === 0
      if (nextBtn) nextBtn.disabled = state.currentIndex === state.totalCards - 1
    }

    // 取得當前卡片的內層 slider
    function getCurrentInnerSlider(): KeenSliderInstance | null {
      const currentSlide = sliderContainer.querySelector(`.main-slide[data-slide-index="${state.currentIndex}"]`)
      const innerEl = currentSlide?.querySelector('.inner-slider') as HTMLElement | null
      if (!innerEl) return null

      return innerSlidersMap.get(innerEl.id) || null
    }

    // 鍵盤事件
    function handleKeydown(e: KeyboardEvent) {
      if (!state.isOpen || !mainSlider) return

      switch (e.key) {
        case 'Escape':
          close()
          break
        case 'ArrowLeft':
          e.preventDefault()
          mainSlider.prev()
          break
        case 'ArrowRight':
          e.preventDefault()
          mainSlider.next()
          break
        case 'ArrowUp':
          e.preventDefault()
          if (state.isDesktop) {
            getCurrentInnerSlider()?.prev()
          }
          break
        case 'ArrowDown':
          e.preventDefault()
          if (state.isDesktop) {
            getCurrentInnerSlider()?.next()
          }
          break
      }
    }

    // 響應式
    mediaQuery.addEventListener('change', (e) => {
      state.isDesktop = e.matches
      // 如果正在開啟狀態，需要重建內層 sliders
      if (state.isOpen && innerSlidersMap.size > 0) {
        // 記錄當前位置
        const positions = new Map<string, number>()
        innerSlidersMap.forEach((slider, id) => {
          positions.set(id, slider.track.details.rel)
        })

        // 銷毀並重建
        innerSlidersMap.forEach(s => s.destroy())
        innerSlidersMap.clear()

        const innerEls = sliderContainer.querySelectorAll('.inner-slider')
        innerEls.forEach((el) => {
          const innerId = (el as HTMLElement).id
          const dotsEl = document.getElementById(`inner-dots-${innerId.split('-')[2]}`)

          const innerSlider = new KeenSlider(el as HTMLElement, {
            vertical: state.isDesktop,
            slides: {
              perView: 1,
              spacing: 0
            },
            rubberband: false,
            created: (s) => {
              // 恢復位置
              const prevPos = positions.get(innerId)
              if (prevPos !== undefined) {
                s.moveToIdx(prevPos)
              }
              updateInnerDots(dotsEl, s.track.details.rel)
            },
            slideChanged: (s) => {
              updateInnerDots(dotsEl, s.track.details.rel)
            }
          })

          innerSlidersMap.set(innerId, innerSlider)
        })
      }
    })

    // 綁定事件
    closeBtn?.addEventListener('click', close)
    backdrop?.addEventListener('click', close)
    prevBtn?.addEventListener('click', () => mainSlider?.prev())
    nextBtn?.addEventListener('click', () => mainSlider?.next())

    // 暴露到 window
    ;(window as any).openCardReader = open
    ;(window as any).closeCardReader = close
  }

  // 初始化
  initCardReader()
  document.addEventListener('astro:page-load', initCardReader)
  document.addEventListener('swup:contentReplaced', initCardReader)
</script>

<style>
  @import 'keen-slider/keen-slider.min.css';

  .card-reader {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 300ms ease, visibility 300ms ease;
  }

  .card-reader.is-open {
    opacity: 1;
    visibility: visible;
  }

  .card-reader-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
  }

  .card-reader-container {
    position: relative;
    width: calc(100% - 2rem);
    height: calc(100vh - 2rem);
    max-width: 600px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }

  /* 主 Slider */
  .card-slider {
    flex: 1;
    overflow: hidden;
    border-radius: 0.75rem;
  }

  /* 主卡片 */
  :global(.main-slide) {
    height: 100%;
    overflow: hidden;
    background: white;
    border-radius: 0.75rem;
  }

  :global(.dark .main-slide) {
    background: #1c1917;
  }

  /* 沒有內層 slider 的卡片內容（可滾動） */
  :global(.card-content) {
    height: 100%;
    overflow-y: auto;
    padding: 3rem 2rem;
    box-sizing: border-box;
    scrollbar-width: thin;
    scrollbar-color: #d6d3d1 transparent;
  }

  :global(.dark .card-content) {
    scrollbar-color: #57534e transparent;
  }

  :global(.card-content)::-webkit-scrollbar {
    width: 4px;
  }

  :global(.card-content)::-webkit-scrollbar-track {
    background: transparent;
  }

  :global(.card-content)::-webkit-scrollbar-thumb {
    background-color: #d6d3d1;
    border-radius: 9999px;
  }

  :global(.dark .card-content)::-webkit-scrollbar-thumb {
    background-color: #57534e;
  }

  /* 有內層 slider 的容器 */
  :global(.inner-slider-wrapper) {
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* 內層 Slider */
  :global(.inner-slider) {
    flex: 1;
    overflow: hidden;
  }

  :global(.inner-slide) {
    height: 100%;
    overflow: hidden;
  }

  :global(.inner-slide-content) {
    height: 100%;
    overflow-y: auto;
    padding: 3rem 2rem;
    box-sizing: border-box;
    scrollbar-width: thin;
    scrollbar-color: #d6d3d1 transparent;
  }

  :global(.dark .inner-slide-content) {
    scrollbar-color: #57534e transparent;
  }

  :global(.inner-slide-content)::-webkit-scrollbar {
    width: 4px;
  }

  :global(.inner-slide-content)::-webkit-scrollbar-track {
    background: transparent;
  }

  :global(.inner-slide-content)::-webkit-scrollbar-thumb {
    background-color: #d6d3d1;
    border-radius: 9999px;
  }

  :global(.dark .inner-slide-content)::-webkit-scrollbar-thumb {
    background-color: #57534e;
  }

  /* 內層圓點 - 手機版在底部 */
  :global(.inner-slider-dots) {
    display: flex;
    justify-content: center;
    gap: 0.375rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid #e7e5e4;
  }

  :global(.dark .inner-slider-dots) {
    background: rgba(28, 25, 23, 0.95);
    border-top-color: #44403c;
  }

  :global(.inner-dot) {
    width: 6px;
    height: 6px;
    border-radius: 9999px;
    background: #d6d3d1;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: background 200ms, transform 200ms;
  }

  :global(.dark .inner-dot) {
    background: #57534e;
  }

  :global(.inner-dot:hover) {
    transform: scale(1.3);
  }

  :global(.inner-dot.is-active) {
    background: #78716c;
  }

  :global(.dark .inner-dot.is-active) {
    background: #a8a29e;
  }

  /* 桌面版：內層圓點放右側 */
  @media (min-width: 768px) {
    :global(.inner-slider-dots) {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      flex-direction: column;
      padding: 0.5rem;
      border-radius: 9999px;
      border-top: none;
      border: 1px solid #e7e5e4;
    }

    :global(.dark .inner-slider-dots) {
      border-color: #44403c;
    }
  }

  /* 關閉按鈕 */
  .card-reader-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #e7e5e4;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 200ms;
    color: #57534e;
  }

  :global(.dark) .card-reader-close {
    background: rgba(28, 25, 23, 0.9);
    border-color: #44403c;
    color: #a8a29e;
  }

  .card-reader-close:hover {
    background: #f5f5f4;
  }

  :global(.dark) .card-reader-close:hover {
    background: #292524;
  }

  /* 導航按鈕 */
  .card-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 3rem;
    height: 3rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #e7e5e4;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: opacity 200ms, background 200ms;
    color: #57534e;
    z-index: 10;
  }

  :global(.dark) .card-nav {
    background: rgba(28, 25, 23, 0.9);
    border-color: #44403c;
    color: #a8a29e;
  }

  .card-nav:hover {
    background: #f5f5f4;
  }

  :global(.dark) .card-nav:hover {
    background: #292524;
  }

  .card-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .card-nav-prev {
    left: -4rem;
  }

  .card-nav-next {
    right: -4rem;
  }

  @media (min-width: 768px) {
    .card-nav {
      display: flex;
    }
  }

  /* 主進度圓點 */
  .card-reader-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 0;
  }

  :global(.card-reader-dot) {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background: #d6d3d1;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: background 200ms, transform 200ms;
  }

  :global(.dark .card-reader-dot) {
    background: #57534e;
  }

  :global(.card-reader-dot:hover) {
    transform: scale(1.2);
  }

  :global(.card-reader-dot.is-active) {
    background: #57534e;
  }

  :global(.dark .card-reader-dot.is-active) {
    background: #d6d3d1;
  }

  /* 手機版 */
  @media (max-width: 767px) {
    .card-reader-container {
      width: 100%;
      height: 100vh;
      max-width: 100%;
      max-height: 100%;
    }

    .card-slider {
      border-radius: 0;
    }

    :global(.main-slide) {
      border-radius: 0;
    }

    .card-reader-close {
      top: 0.5rem;
      right: 0.5rem;
    }

    .card-reader-dots {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
    }

    :global(.dark) .card-reader-dots {
      background: rgba(28, 25, 23, 0.9);
    }
  }
</style>
