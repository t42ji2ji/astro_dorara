---
import { Image } from 'astro:assets'
import type { Post } from '~/types'

interface Props {
  post: Post
}

const { post } = Astro.props
const banner = post.data.banner

// 取得文章前言內容（直接處理 markdown 原文，保留段落結構）
function getPreviewContent(post: Post): string {
  let body = post.body || ''

  // 移除 MDX import/export 語句
  body = body.replace(/^import\s+.*$/gm, '')
  body = body.replace(/^export\s+.*$/gm, '')
  // 移除 JSX/MDX 組件標籤
  body = body.replace(/<[A-Z][a-zA-Z]*[^>]*\/>/g, '')
  body = body.replace(/<[A-Z][a-zA-Z]*[^>]*>[\s\S]*?<\/[A-Z][a-zA-Z]*>/g, '')
  // 移除所有 HTML 標籤
  body = body.replace(/<[^>]+>/g, '')
  // 移除 frontmatter
  body = body.replace(/^---[\s\S]*?---/m, '')
  // 移除 markdown 標題
  body = body.replace(/^#{1,6}\s+.*$/gm, '')
  // 移除 blockquote
  body = body.replace(/^>\s+.*$/gm, '')
  // 移除水平線
  body = body.replace(/^---+$/gm, '')
  // 移除 markdown 連結，保留文字
  body = body.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
  // 移除粗體/斜體標記
  body = body.replace(/\*\*([^*]+)\*\*/g, '$1')
  body = body.replace(/\*([^*]+)\*/g, '$1')
  // 移除 inline code
  body = body.replace(/`([^`]+)`/g, '$1')

  // 保留段落間的空行
  const cleaned = body
    .split(/\n{2,}/)
    .map((p) => p.replace(/\s+/g, ' ').trim())
    .filter((p) => p.length > 0)
    .join('\n\n')

  const trimmed = cleaned.slice(0, 200)
  return trimmed + (cleaned.length > 200 ? '...' : '')
}

const previewContent = getPreviewContent(post)
---

<!-- 預覽卡片的模板，會被 JS 移到 body -->
<template class="preview-card-template">
  <div class="preview-card not-prose">
    <div class="preview-card-inner">
      {
        banner && (
          <div class="preview-thumbnail">
            <Image src={banner} alt={post.data.title} class="w-full h-full object-cover" />
          </div>
        )
      }
      <div class="preview-content">
        <p class="preview-text">{previewContent}</p>
        <span class="preview-hint">點擊閱讀全文 →</span>
      </div>
    </div>
  </div>
</template>

<script>
  const win = window as any

  function initPreviewCard(wrapper: Element) {
    // 跳過已初始化的 wrapper
    if ((wrapper as any).__previewCardInit) {
      return
    }
    ;(wrapper as any).__previewCardInit = true

    const template = wrapper.querySelector('.preview-card-template') as HTMLTemplateElement
    if (!template) {
      return
    }

    const card = template.content.cloneNode(true) as DocumentFragment
    const cardEl = card.querySelector('.preview-card') as HTMLElement
    if (!cardEl) {
      return
    }

    cardEl.style.display = 'none'
    document.body.appendChild(cardEl)

    let isHovering = false
    let hideTimeout: ReturnType<typeof setTimeout> | null = null

    const showCard = () => {
      if (window.innerWidth <= 768) {
        return
      }

      if (hideTimeout) {
        clearTimeout(hideTimeout)
        hideTimeout = null
      }

      isHovering = true
      const rect = wrapper.getBoundingClientRect()

      cardEl.style.position = 'fixed'
      cardEl.style.left = `${rect.right + 16}px`
      cardEl.style.top = `${rect.top}px`
      cardEl.style.display = 'block'

      void cardEl.offsetHeight
      cardEl.classList.add('is-visible')
    }

    const hideCard = () => {
      isHovering = false
      cardEl.classList.remove('is-visible')
      hideTimeout = setTimeout(() => {
        if (!isHovering) {
          cardEl.style.display = 'none'
        }
        hideTimeout = null
      }, 350)
    }

    const onCardEnter = () => {
      if (hideTimeout) {
        clearTimeout(hideTimeout)
        hideTimeout = null
      }
      isHovering = true
      cardEl.classList.add('is-visible')
    }

    wrapper.addEventListener('mouseenter', showCard)
    wrapper.addEventListener('mouseleave', hideCard)
    cardEl.addEventListener('mouseenter', onCardEnter)
    cardEl.addEventListener('mouseleave', hideCard)
  }

  function initAllPreviewCards() {
    // 先清理舊的卡片，確保乾淨的狀態
    cleanupPreviewCards()
    document.querySelectorAll('.post-item-wrapper').forEach(initPreviewCard)
  }

  function cleanupPreviewCards() {
    // 移除所有卡片
    document.querySelectorAll('body > .preview-card').forEach((card) => card.remove())
    // 重置所有 wrapper 的初始化標記
    document.querySelectorAll('.post-item-wrapper').forEach((wrapper) => {
      ;(wrapper as any).__previewCardInit = false
    })
  }

  // 初始化當前頁面的卡片
  initAllPreviewCards()

  // 全局只設置一次
  if (!win.__previewCardGlobalInit) {
    win.__previewCardGlobalInit = true

    // 點擊連結時立即隱藏卡片
    document.addEventListener('click', (e) => {
      const link = (e.target as Element).closest('a')
      if (link?.href && !link.href.startsWith('javascript:')) {
        document.querySelectorAll('body > .preview-card').forEach((card) => {
          ;(card as HTMLElement).style.display = 'none'
        })
      }
    })

    // Swup 頁面轉換前清理所有卡片
    document.addEventListener('swup:willReplaceContent', cleanupPreviewCards)

    // Swup 頁面轉換後初始化新的卡片
    document.addEventListener('swup:contentReplaced', initAllPreviewCards)

    // 用 MutationObserver 監聽 DOM 變化，自動初始化新的 wrapper（非 Swup 情況）
    const observer = new MutationObserver((mutations) => {
      for (const mutation of mutations) {
        mutation.addedNodes.forEach((node) => {
          if (node instanceof Element) {
            if (node.classList.contains('post-item-wrapper')) {
              initPreviewCard(node)
            }
            node.querySelectorAll('.post-item-wrapper').forEach(initPreviewCard)
          }
        })
      }
    })

    observer.observe(document.body, { childList: true, subtree: true })
  }
</script>

<style is:global>
  .preview-card {
    position: fixed;
    z-index: 9999;
    width: 280px;
    pointer-events: none;
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .preview-card:hover {
    background: transparent;
    color: inherit;
  }

  .preview-card-inner {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: rgba(250, 250, 249, 0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(231, 229, 228, 0.6);
    border-radius: 8px;
    overflow: hidden;
    padding: 1rem;
    opacity: 0;
    transform: translateX(-12px) scale(0.96);
    transform-origin: left center;
    transition:
      opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .dark .preview-card-inner {
    background: rgba(41, 37, 36, 0.9);
    border-color: rgba(68, 64, 60, 0.6);
  }

  .preview-card.is-visible {
    pointer-events: auto;
  }

  .preview-card.is-visible .preview-card-inner {
    opacity: 1;
    transform: translateX(0) scale(1);
  }

  .preview-card .preview-content {
    flex: 1;
    min-width: 0;
  }

  .preview-card .preview-thumbnail {
    flex-shrink: 0;
    width: 100%;
    height: 120px;
    border-radius: 6px;
    overflow: hidden;
  }

  .preview-card .preview-thumbnail img {
    margin: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .preview-card .preview-text {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.7;
    color: #57534e;
    white-space: pre-line;
    text-decoration: none;
  }

  .dark .preview-card .preview-text {
    color: #a8a29e;
  }

  .preview-card .preview-hint {
    display: block;
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: #a8a29e;
  }

  .dark .preview-card .preview-hint {
    color: #78716c;
  }
</style>
