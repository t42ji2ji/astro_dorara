---
import { Image } from 'astro:assets'
import type { Post } from '~/types'

interface Props {
  post: Post
}

const { post } = Astro.props
const banner = post.data.banner

// 取得文章前言內容（直接處理 markdown 原文，保留段落結構）
function getPreviewContent(post: Post): string {
  let body = post.body || ''

  // 移除 MDX import/export 語句
  body = body.replace(/^import\s+.*$/gm, '')
  body = body.replace(/^export\s+.*$/gm, '')
  // 移除 JSX/MDX 組件標籤
  body = body.replace(/<[A-Z][a-zA-Z]*[^>]*\/>/g, '')
  body = body.replace(/<[A-Z][a-zA-Z]*[^>]*>[\s\S]*?<\/[A-Z][a-zA-Z]*>/g, '')
  // 移除 frontmatter
  body = body.replace(/^---[\s\S]*?---/m, '')
  // 移除 markdown 標題
  body = body.replace(/^#{1,6}\s+.*$/gm, '')
  // 移除 blockquote
  body = body.replace(/^>\s+.*$/gm, '')
  // 移除水平線
  body = body.replace(/^---+$/gm, '')
  // 移除 markdown 連結，保留文字
  body = body.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
  // 移除粗體/斜體標記
  body = body.replace(/\*\*([^*]+)\*\*/g, '$1')
  body = body.replace(/\*([^*]+)\*/g, '$1')
  // 移除 inline code
  body = body.replace(/`([^`]+)`/g, '$1')

  // 保留段落間的空行
  const cleaned = body
    .split(/\n{2,}/)
    .map(p => p.replace(/\s+/g, ' ').trim())
    .filter(p => p.length > 0)
    .join('\n\n')

  const trimmed = cleaned.slice(0, 200)
  return trimmed + (cleaned.length > 200 ? '...' : '')
}

const previewContent = getPreviewContent(post)
---

<a href={`/posts/${post.id}/`} class="preview-card not-prose">
  <div class="preview-card-inner">
    <div class="preview-content">
      <p class="preview-text">{previewContent}</p>
      <span class="preview-hint">點擊閱讀全文 →</span>
    </div>
    {
      banner && (
        <div class="preview-thumbnail">
          <Image src={banner} alt={post.data.title} class="w-full h-full object-cover" />
        </div>
      )
    }
  </div>
</a>

<style>
  .preview-card {
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    z-index: 50;

    /* 用 padding-top 代替 margin-top，讓 hover 區域連續 */
    padding-top: 0.5rem;

    pointer-events: none;
    max-width: 100%;

    /* 移除連結預設樣式 */
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .preview-card:hover {
    background: transparent;
    color: inherit;
  }

  .preview-card-inner {
    display: flex;
    gap: 1rem;
    background: rgba(250, 250, 249, 0.522);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(231, 229, 228, 0.6);
    border-radius: 8px;
    overflow: hidden;
    padding: 1rem;

    /* 動畫放在 inner，避免 backdrop-filter 突兀 */
    opacity: 0;
    transform: translateY(-4px) scale(0.98);
    transform-origin: top center;
    transition:
      opacity 0.2s ease-out,
      transform 0.2s ease-out;
  }

  :global(.dark) .preview-card-inner {
    background: rgba(41, 37, 36, 0.8);
    border-color: rgba(68, 64, 60, 0.6);
  }

  :global(.post-item-wrapper:hover) .preview-card,
  .preview-card:hover {
    pointer-events: auto;
  }

  :global(.post-item-wrapper:hover) .preview-card-inner,
  .preview-card:hover .preview-card-inner {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  .preview-content {
    flex: 1;
    min-width: 0;
  }

  .preview-thumbnail {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: 6px;
    overflow: hidden;
  }

  .preview-thumbnail :global(img) {
    margin: 0;
  }

  .preview-text {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.7;
    color: #57534e;
    white-space: pre-line;
  }

  :global(.dark) .preview-text {
    color: #a8a29e;
  }

  .preview-hint {
    display: block;
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: #a8a29e;
  }

  :global(.dark) .preview-hint {
    color: #78716c;
  }

  /* 在小螢幕上隱藏預覽卡片 */
  @media (max-width: 768px) {
    .preview-card {
      display: none;
    }
  }
</style>
