---
import InteractiveContainer from '../InteractiveContainer.astro'
---

<InteractiveContainer
  title="æ…¾æœ›çš„èª•ç”Ÿ"
  description="åŒä¸€å€‹äººï¼ŒåŒä¸€å€‹ç‰©å“ã€‚å·®åˆ¥åªåœ¨æ–¼â€”â€”æœ‰æ²’æœ‰ã€Œåˆ¥äººã€åœ¨å ´ã€‚"
  id="mimetic-desire-demo"
>
  <div class="mimetic-stage">
    <!-- Two parallel scenarios -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Scenario A: Alone -->
      <div class="scenario-box p-4">
        <div class="text-xs text-stone-400 mb-4 text-center">ç¨è‡ªä¸€äºº</div>

        <div class="scene relative h-32 flex items-center justify-center gap-6">
          <!-- Person A -->
          <div class="person-a flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-stone-100 dark:bg-stone-800 flex items-center justify-center">
              <span class="text-xl">ğŸ‘¤</span>
            </div>
            <div class="mt-2 text-xs text-stone-400" id="person-a-status">çœ‹è‘—...</div>
          </div>

          <!-- Object -->
          <div class="object-a flex flex-col items-center">
            <div class="w-10 h-10 flex items-center justify-center" id="object-a">
              <span class="text-xl">ğŸ‘œ</span>
            </div>
          </div>
        </div>

        <!-- Thought bubble A -->
        <div class="thought-a mt-2 text-center opacity-0 transition-all duration-500" id="thought-a">
          <span class="text-sm text-stone-400">ã€Œé‚„å¥½å§ã€</span>
        </div>
      </div>

      <!-- Scenario B: With mediator -->
      <div class="scenario-box p-4 border-l border-stone-200 dark:border-stone-700">
        <div class="text-xs text-stone-400 mb-4 text-center">æœ‰äººåœ¨å ´</div>

        <div class="scene relative h-32 flex items-center justify-center gap-4">
          <!-- Person B -->
          <div class="person-b flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-stone-100 dark:bg-stone-800 flex items-center justify-center">
              <span class="text-xl">ğŸ‘¤</span>
            </div>
            <div class="mt-2 text-xs text-stone-400" id="person-b-status">çœ‹è‘—...</div>
          </div>

          <!-- Object -->
          <div class="object-b flex flex-col items-center relative">
            <div class="w-10 h-10 flex items-center justify-center transition-all duration-500" id="object-b">
              <span class="text-xl">ğŸ‘œ</span>
            </div>
            <!-- Desire indicator from mediator -->
            <div
              class="absolute -top-1 -right-1 text-xs opacity-0 scale-0 transition-all duration-300"
              id="mediator-want"
            >
              â¤ï¸
            </div>
          </div>

          <!-- Mediator -->
          <div class="mediator flex flex-col items-center opacity-0 transition-all duration-500" id="mediator">
            <div class="w-12 h-12 rounded-full bg-stone-200 dark:bg-stone-700 flex items-center justify-center">
              <span class="text-xl">ğŸ‘¤</span>
            </div>
            <div class="mt-2 text-xs text-stone-500">ä»–</div>
          </div>
        </div>

        <!-- Thought bubble B -->
        <div class="thought-b mt-2 text-center opacity-0 transition-all duration-500" id="thought-b">
          <span class="text-sm text-stone-700 dark:text-stone-300 font-medium">ã€Œæˆ‘ä¹Ÿæƒ³è¦ã€</span>
        </div>
      </div>
    </div>

    <!-- Timeline indicator -->
    <div class="mt-6 relative">
      <div class="h-px bg-stone-200 dark:bg-stone-700 overflow-hidden">
        <div
          class="h-full bg-stone-400 dark:bg-stone-500 transition-all duration-1000 ease-linear"
          id="timeline-bar"
          style="width: 0%"
        >
        </div>
      </div>
      <div class="mt-2 text-xs text-stone-400 text-center" id="phase-label">è§€å¯Ÿç‰©å“</div>
    </div>

    <!-- Insight -->
    <div class="mt-6 opacity-0 transition-all duration-500" id="insight-box">
      <p class="text-sm text-stone-500 dark:text-stone-400 text-center">
        åŒæ¨£çš„ç‰©å“ï¼ŒåŒæ¨£çš„äººã€‚<br />
        å”¯ä¸€çš„å·®åˆ¥æ˜¯<span class="text-stone-700 dark:text-stone-300">åˆ¥äººçš„æ…¾æœ›</span>ã€‚
      </p>
    </div>

    <!-- Controls -->
    <div class="mt-4 text-center">
      <button
        class="text-xs text-stone-400 hover:text-stone-600 dark:hover:text-stone-300 transition-colors"
        id="replay-btn"
      >
        é‡æ’­
      </button>
    </div>
  </div>
</InteractiveContainer>

<script>
  function initMimeticDesire() {
    const container = document.getElementById('mimetic-desire-demo')
    if (!container) 
return

    // Elements
    const thoughtA = container.querySelector('#thought-a')
    const thoughtB = container.querySelector('#thought-b')
    const mediator = container.querySelector('#mediator')
    const mediatorWant = container.querySelector('#mediator-want')
    const personAStatus = container.querySelector('#person-a-status')
    const personBStatus = container.querySelector('#person-b-status')
    const timelineBar = container.querySelector('#timeline-bar') as HTMLElement
    const phaseLabel = container.querySelector('#phase-label')
    const insightBox = container.querySelector('#insight-box')
    const replayBtn = container.querySelector('#replay-btn')

    let animationTimeout: number[] = []

    function clearAnimations() {
      animationTimeout.forEach((t) => clearTimeout(t))
      animationTimeout = []
    }

    function runAnimation() {
      clearAnimations()

      // Reset all states
      thoughtA?.classList.add('opacity-0')
      thoughtB?.classList.add('opacity-0')
      mediator?.classList.add('opacity-0')
      mediatorWant?.classList.add('opacity-0', 'scale-0')
      mediatorWant?.classList.remove('opacity-100', 'scale-100')
      insightBox?.classList.add('opacity-0')
      if (timelineBar) 
timelineBar.style.width = '0%'
      if (personAStatus) 
personAStatus.textContent = 'çœ‹è‘—...'
      if (personBStatus) 
personBStatus.textContent = 'çœ‹è‘—...'
      if (phaseLabel) 
phaseLabel.textContent = 'è§€å¯Ÿç‰©å“'

      // Phase 1: Both looking (0-1.5s)
      animationTimeout.push(
        window.setTimeout(() => {
          if (timelineBar) 
timelineBar.style.width = '25%'
        }, 500),
      )

      // Phase 2: A indifferent, mediator appears (1.5-3s)
      animationTimeout.push(
        window.setTimeout(() => {
          if (timelineBar) 
timelineBar.style.width = '50%'
          if (phaseLabel) 
phaseLabel.textContent = 'ä¸­ä»‹è€…å‡ºç¾'

          thoughtA?.classList.remove('opacity-0')
          if (personAStatus) 
personAStatus.textContent = 'ç„¡æ„Ÿ'

          mediator?.classList.remove('opacity-0')
        }, 1500),
      )

      // Phase 3: Mediator shows desire (3-4s)
      animationTimeout.push(
        window.setTimeout(() => {
          if (timelineBar) 
timelineBar.style.width = '75%'
          if (phaseLabel) 
phaseLabel.textContent = 'ä»–æƒ³è¦'

          mediatorWant?.classList.remove('opacity-0', 'scale-0')
          mediatorWant?.classList.add('opacity-100', 'scale-100')

          if (personBStatus) 
personBStatus.textContent = '...'
        }, 3000),
      )

      // Phase 4: B catches desire (4-5s)
      animationTimeout.push(
        window.setTimeout(() => {
          if (timelineBar) 
timelineBar.style.width = '100%'
          if (phaseLabel) 
phaseLabel.textContent = 'æ…¾æœ›å‚³æŸ“'

          thoughtB?.classList.remove('opacity-0')
          if (personBStatus) 
personBStatus.textContent = 'æƒ³è¦'
        }, 4000),
      )

      // Phase 5: Show insight (5s)
      animationTimeout.push(
        window.setTimeout(() => {
          insightBox?.classList.remove('opacity-0')
        }, 5000),
      )
    }

    // Auto-start animation
    runAnimation()

    // Replay button
    replayBtn?.addEventListener('click', runAnimation)

    // Cleanup on page transition
    const cleanup = () => clearAnimations()
    document.addEventListener('swup:willReplaceContent', cleanup, { once: true })
  }

  // Initialize
  initMimeticDesire()
  document.addEventListener('swup:contentReplaced', initMimeticDesire)
  document.addEventListener('cardreader:open', initMimeticDesire)
</script>
