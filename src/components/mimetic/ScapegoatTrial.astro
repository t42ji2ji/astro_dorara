---
import InteractiveContainer from '../InteractiveContainer.astro'
---

<InteractiveContainer title="ç¤¾ç¾¤ä»²è£æ¨¡æ“¬" description="ä½ è¢«é¸ç‚ºç¤¾ç¾¤ä»²è£å“¡ã€‚è«‹å¯©ç†ä»¥ä¸‹æª¢èˆ‰æ¡ˆä»¶ã€‚" id="scapegoat-trial">
  <div class="trial-container relative">
    <!-- Phase 1: Case Presentation -->
    <div class="phase phase-case" id="phase-case">
      <!-- Timer Bar - Prominent -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs text-stone-500">å¯©ç†æ™‚é–“</span>
          <span class="text-xs text-stone-400">å¹³å‡ 8 ç§’</span>
        </div>
        <div class="relative h-2 bg-stone-200 dark:bg-stone-700 rounded-full overflow-hidden">
          <div
            class="timer-bar absolute left-0 top-0 h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 transition-all duration-1000 ease-linear"
            id="timer-bar"
            style="width: 0%"
          >
          </div>
        </div>
        <div class="flex justify-between mt-1">
          <span class="text-2xl font-mono font-bold text-stone-800 dark:text-stone-200" id="timer-value">0</span>
          <span class="text-xs text-stone-400 self-end">ç§’</span>
        </div>
      </div>

      <!-- Case Badge -->
      <div class="flex items-center gap-2 mb-4">
        <span class="px-2 py-0.5 bg-red-500 text-white text-xs font-medium rounded"> ä»‡æ¨è¨€è«– </span>
        <span class="text-xs text-stone-400">æ¡ˆä»¶ #4782</span>
      </div>

      <!-- Reported Content - Clean Card -->
      <div class="bg-white dark:bg-stone-900 rounded-lg border border-stone-200 dark:border-stone-700 p-4 mb-4">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-8 h-8 rounded-full bg-stone-200 dark:bg-stone-700 flex items-center justify-center text-sm">
            ğŸ‘¤
          </div>
          <div class="text-sm text-stone-600 dark:text-stone-400">åŒ¿åç”¨æˆ¶</div>
        </div>
        <p class="text-stone-800 dark:text-stone-200 leading-relaxed">
          ã€Œé€™äº›äººæ ¹æœ¬ä¸æ‡‚ä»€éº¼å«åšåŠªåŠ›ï¼Œåªæœƒåœ¨é‚£é‚ŠæŠ±æ€¨ç¤¾æœƒä¸å…¬å¹³ã€‚ã€
        </p>
      </div>

      <!-- Social Proof - Compact -->
      <div class="flex items-center gap-4 mb-4 text-sm">
        <span class="text-red-500 font-medium">ğŸš¨ 247 äººæª¢èˆ‰</span>
        <span class="text-stone-500">92% é¸æ“‡å°ç¦</span>
      </div>

      <!-- Community Reaction - Streaming (fixed height) -->
      <div class="mb-4 text-sm">
        <div class="text-xs text-stone-400 uppercase tracking-wider mb-2">ç¤¾ç¾¤åæ‡‰</div>
        <div class="h-20 overflow-hidden relative" id="reactions-container">
          <!-- Reactions will be added dynamically -->
        </div>
      </div>

      <!-- Context Link - Clickable -->
      <button
        class="w-full text-left text-sm text-stone-400 hover:text-stone-600 dark:hover:text-stone-300 py-2 flex items-center gap-2 transition-colors"
        id="context-btn"
      >
        <span class="text-xs">â–¶</span>
        <span>æŸ¥çœ‹å®Œæ•´å°è©±ä¸²ï¼ˆ12 å‰‡ç•™è¨€ï¼‰</span>
      </button>

      <!-- Decision Buttons - Prominent -->
      <div class="mt-6 space-y-3">
        <button
          class="decision-btn w-full py-4 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium text-base transition-all shadow-lg shadow-red-500/20 hover:shadow-red-500/30"
          data-decision="ban"
        >
          å°ç¦æ­¤ç”¨æˆ¶
        </button>
        <div class="grid grid-cols-2 gap-3">
          <button
            class="decision-btn py-3 rounded-lg border border-stone-300 dark:border-stone-600 text-stone-600 dark:text-stone-400 text-sm hover:bg-stone-100 dark:hover:bg-stone-800 transition-all"
            data-decision="info"
          >
            éœ€è¦æ›´å¤šè³‡è¨Š
          </button>
          <button
            class="decision-btn py-3 rounded-lg border border-stone-300 dark:border-stone-600 text-stone-600 dark:text-stone-400 text-sm hover:bg-stone-100 dark:hover:bg-stone-800 transition-all"
            data-decision="dismiss"
          >
            æ’¤éŠ·æª¢èˆ‰
          </button>
        </div>
      </div>

      <!-- Queue pressure -->
      <div class="mt-4 text-center text-xs text-stone-400">
        é‚„æœ‰ <span class="text-orange-500">12 å€‹æ¡ˆä»¶</span> ç­‰å¾…å¯©ç†
      </div>
    </div>

    <!-- Phase 2: The Reveal -->
    <div class="phase phase-reveal hidden" id="phase-reveal">
      <div class="text-center mb-6">
        <div class="text-3xl mb-2">âš ï¸</div>
        <h4 class="text-xl font-bold text-stone-800 dark:text-stone-200">ç­‰ä¸€ä¸‹</h4>
      </div>

      <!-- Stats -->
      <div class="bg-stone-100 dark:bg-stone-800 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-2xl font-mono font-bold text-stone-800 dark:text-stone-200" id="reveal-time">--</div>
            <div class="text-xs text-stone-500">ç§’</div>
          </div>
          <div>
            <div class="text-2xl font-bold" id="reveal-context">å¦</div>
            <div class="text-xs text-stone-500">æŸ¥çœ‹å°è©±</div>
          </div>
          <div>
            <div class="text-2xl" id="reveal-decision-icon">--</div>
            <div class="text-xs text-stone-500">åˆ¤æ±º</div>
          </div>
        </div>
      </div>

      <!-- Truths -->
      <div class="space-y-3 mb-6">
        <div class="reveal-item opacity-0 transform translate-y-2 transition-all duration-300">
          <div class="bg-white dark:bg-stone-900 rounded-lg p-3 border border-stone-200 dark:border-stone-700">
            <div class="text-xs text-stone-400 mb-1">#1 å®Œæ•´è„ˆçµ¡</div>
            <p class="text-sm text-stone-700 dark:text-stone-300">
              é€™å‰‡è²¼æ–‡æ˜¯åœ¨<strong>åé§</strong>ã€Œçª®äººæ´»è©²é¤“æ­»ã€çš„æ¥µç«¯è¨€è«–ã€‚
            </p>
          </div>
        </div>

        <div class="reveal-item opacity-0 transform translate-y-2 transition-all duration-300">
          <div class="bg-white dark:bg-stone-900 rounded-lg p-3 border border-stone-200 dark:border-stone-700">
            <div class="text-xs text-stone-400 mb-1">#2 æª¢èˆ‰ä¾†æº</div>
            <p class="text-sm text-stone-700 dark:text-stone-300">
              247 å€‹æª¢èˆ‰ä¸­ï¼Œ<span class="text-red-500 font-medium">231 å€‹</span>ä¾†è‡ªåŒä¸€å€‹ç¾¤çµ„çš„é›†é«”è¡Œå‹•ã€‚
            </p>
          </div>
        </div>

        <div class="reveal-item opacity-0 transform translate-y-2 transition-all duration-300">
          <div class="bg-white dark:bg-stone-900 rounded-lg p-3 border border-stone-200 dark:border-stone-700">
            <div class="text-xs text-stone-400 mb-1">#3 è­‰æ“šç¯©é¸</div>
            <p class="text-sm text-stone-700 dark:text-stone-300">
              ã€Œå…¶ä»–è²¼æ–‡ã€æ˜¯åˆ»æ„æŒ‘é¸çš„ã€‚127 å‰‡è²¼æ–‡ä¸­ï¼Œå¤§éƒ¨åˆ†æ˜¯æ­£å¸¸å…§å®¹ã€‚
            </p>
          </div>
        </div>

        <div class="reveal-item opacity-0 transform translate-y-2 transition-all duration-300">
          <div class="bg-white dark:bg-stone-900 rounded-lg p-3 border border-stone-200 dark:border-stone-700">
            <div class="text-xs text-stone-400 mb-1">#4 æ•¸æ“šé€ å‡</div>
            <p class="text-sm text-stone-700 dark:text-stone-300">
              ã€Œ92% é¸æ“‡å°ç¦ã€æ˜¯<span class="text-red-500 font-medium">ç·¨é€ çš„</span>ã€‚è¢«éš±è—çš„ç•™è¨€åŸæœ¬æœ‰ 47 è®šã€‚
            </p>
          </div>
        </div>
      </div>

      <!-- Final message -->
      <div class="reveal-item opacity-0 transform translate-y-2 transition-all duration-300">
        <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 border border-red-200 dark:border-red-800">
          <p class="text-red-800 dark:text-red-300 text-sm leading-relaxed" id="final-message">
            <!-- Filled by JS -->
          </p>
        </div>
      </div>

      <!-- Quote -->
      <div class="reveal-item opacity-0 transform translate-y-2 transition-all duration-300 mt-6">
        <p class="text-sm text-stone-500 dark:text-stone-400 italic text-center">
          ã€Œæ›¿ç½ªç¾Šå¿…é ˆè¢«è¦–ç‚ºçœŸæ­£çš„ç½ªçŠ¯ï¼Œæ©Ÿåˆ¶æ‰èƒ½é‹ä½œã€‚ã€<br />
          <span class="not-italic text-xs">â€” RenÃ© Girard</span>
        </p>
      </div>

      <!-- Restart -->
      <div class="mt-6 text-center">
        <button
          class="text-sm text-stone-400 hover:text-stone-600 dark:hover:text-stone-300 underline"
          id="restart-btn"
        >
          é‡æ–°é«”é©—
        </button>
      </div>
    </div>
  </div>
</InteractiveContainer>

<script>
  function initScapegoatTrial() {
    const container = document.getElementById('scapegoat-trial')
    if (!container)
return

    // Elements
    const phaseCase = container.querySelector('#phase-case')
    const phaseReveal = container.querySelector('#phase-reveal')
    const timerValue = container.querySelector('#timer-value')
    const timerBar = container.querySelector('#timer-bar') as HTMLElement
    const contextBtn = container.querySelector('#context-btn')
    const decisionBtns = container.querySelectorAll('.decision-btn')
    const restartBtn = container.querySelector('#restart-btn')

    // Reveal elements
    const revealTime = container.querySelector('#reveal-time')
    const revealContext = container.querySelector('#reveal-context')
    const revealDecisionIcon = container.querySelector('#reveal-decision-icon')
    const finalMessage = container.querySelector('#final-message')
    const revealItems = container.querySelectorAll('.reveal-item')

    // State
    let startTime = Date.now()
    let timerInterval: number | null = null
    let reactionInterval: number | null = null
    let checkedContext = false
    let decision: string | null = null
    const maxTime = 60 // seconds for full bar

    // Reactions data - angry mob comments
    const reactions = [
      { text: 'é€™ç¨®äººå°±æ˜¯ç¤¾æœƒçš„æ¯’ç˜¤', votes: 89 },
      { text: 'å°è™Ÿå‰›å¥½è€Œå·²', votes: 156 },
      { text: 'ç¾åœ¨çš„å¹´è¼•äººå°±æ˜¯é€™æ¨£', votes: 67 },
      { text: 'ä¸å–œæ­¡å°±é›¢é–‹å•Šï¼Œæ²’äººé€¼ä½ ', votes: 203 },
      { text: 'çœ‹äº†å°±ç”Ÿæ°£', votes: 45 },
      { text: 'é€™ç¨®è¨€è«–æ€éº¼é‚„æ²’è¢«å°', votes: 178 },
      { text: 'çµ‚æ–¼ç­‰åˆ°æœ‰äººæª¢èˆ‰äº†', votes: 92 },
      { text: 'æ”¯æŒå°ç¦ +1', votes: 234 },
      { text: 'é€™äººé‚„æœ‰è‡‰å‡ºä¾†è¬›è©±ï¼Ÿ', votes: 156 },
      { text: 'ç¤¾æœƒæ•—é¡', votes: 78 },
      { text: 'æª¢èˆ‰äº† å¤§å®¶å¿«è·Ÿä¸Š', votes: 312 },
      { text: 'é€™ç¨®äººå°±æ˜¯éœ€è¦è¢«æ•™è¨“', votes: 189 },
      { text: 'ç¬‘æ­» é‚„åœ¨æ›¿ä»–èªªè©±çš„æ˜¯ä»€éº¼äºº', votes: 267 },
      { text: 'è¬›é€™ç¨®è©±æ´»è©²è¢«å…¬å¯©', votes: 145 },
      { text: 'å·²æˆªåœ–å­˜è­‰', votes: 88 },
    ]
    let reactionIndex = 0
    const reactionsContainer = container.querySelector('#reactions-container')

    // Add a new reaction (slide down effect in fixed container)
    const lineHeight = 24 // px per line
    function addReaction() {
      if (!reactionsContainer)
return

      // Loop back if we've used all reactions
      const reaction = reactions[reactionIndex % reactions.length]

      // Slide existing items down
      const existingItems = reactionsContainer.querySelectorAll('.reaction-item')
      existingItems.forEach((item) => {
        const el = item as HTMLElement
        const currentTop = Number.parseInt(el.style.top || '0')
        el.style.top = `${currentTop + lineHeight}px`

        // Fade out items that go past container
        if (currentTop + lineHeight >= lineHeight * 3) {
          el.style.opacity = '0'
          setTimeout(() => el.remove(), 300)
        }
      })

      // Create new item at top
      const div = document.createElement('div')
      div.className
        = 'reaction-item absolute left-0 right-0 text-stone-600 dark:text-stone-400 transition-all duration-300'
      div.style.top = '0px'
      div.style.opacity = '0'
      div.innerHTML = `ã€Œ${reaction.text}ã€<span class="text-red-400 ml-1">+${reaction.votes}</span>`

      reactionsContainer.appendChild(div)

      // Animate in
      requestAnimationFrame(() => {
        div.style.opacity = '1'
      })

      reactionIndex++
    }

    // Start streaming reactions
    function startReactions() {
      // Add first two immediately
      addReaction()
      setTimeout(addReaction, 300)

      // Then add more periodically
      reactionInterval = window.setInterval(
        () => {
          addReaction()
        },
        1500 + Math.random() * 1000,
      ) // 1.5-2.5 seconds
    }

    function stopReactions() {
      if (reactionInterval) {
        clearInterval(reactionInterval)
        reactionInterval = null
      }
    }

    // Context button click
    contextBtn?.addEventListener('click', () => {
      checkedContext = true
      const btn = contextBtn as HTMLElement
      btn.innerHTML = `<span class="text-xs">âœ“</span><span class="text-green-600 dark:text-green-400">å·²æŸ¥çœ‹å®Œæ•´å°è©±ä¸²</span>`
      btn.classList.add('text-green-600', 'dark:text-green-400')
      btn.classList.remove('text-stone-400')
    })

    // Timer with progress bar
    function startTimer() {
      startTime = Date.now()
      timerInterval = window.setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000)
        if (timerValue)
timerValue.textContent = elapsed.toString()

        // Update progress bar
        if (timerBar) {
          const progress = Math.min((elapsed / maxTime) * 100, 100)
          timerBar.style.width = `${progress}%`
        }

        // Add urgency styling
        if (elapsed > 15 && timerValue) {
          timerValue.classList.add('text-orange-500')
        }
        if (elapsed > 30 && timerValue) {
          timerValue.classList.remove('text-orange-500')
          timerValue.classList.add('text-red-500')
        }
      }, 1000)
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval)
        timerInterval = null
      }
      stopReactions()
    }

    // Handle decision
    function handleDecision(btn: Element) {
      decision = btn.getAttribute('data-decision')
      stopTimer()

      const elapsed = Math.floor((Date.now() - startTime) / 1000)

      // Update reveal stats
      if (revealTime)
revealTime.textContent = elapsed.toString()
      if (revealContext) {
        revealContext.textContent = checkedContext ? 'æ˜¯' : 'å¦'
        revealContext.classList.toggle('text-red-500', !checkedContext)
        revealContext.classList.toggle('text-green-500', checkedContext)
      }

      // Update decision icon
      if (revealDecisionIcon) {
        switch (decision) {
          case 'ban':
            revealDecisionIcon.textContent = 'ğŸš«'
            break
          case 'info':
            revealDecisionIcon.textContent = 'â“'
            break
          case 'dismiss':
            revealDecisionIcon.textContent = 'âœ“'
            break
        }
      }

      // Set final message
      if (finalMessage) {
        if (decision === 'ban') {
          if (elapsed < 15 && !checkedContext) {
            finalMessage.innerHTML = `ä½ åœ¨ <strong>${elapsed} ç§’</strong>å…§åšå‡ºåˆ¤æ±ºï¼Œæ²’æœ‰æŸ¥çœ‹å®Œæ•´å°è©±ã€‚<br><br>ä½ å‰›æ‰å°ç¦çš„ï¼Œæ˜¯ä¸€å€‹è¢«çµ„ç¹”æ€§éœ¸å‡Œçš„å—å®³è€…ã€‚`
          } else if (!checkedContext) {
            finalMessage.innerHTML = `ä½ æ²’æœ‰æŸ¥çœ‹å®Œæ•´å°è©±å°±åšå‡ºåˆ¤æ±ºã€‚<br><br>ä½ å‰›æ‰å°ç¦çš„ï¼Œæ˜¯ä¸€å€‹è¢«çµ„ç¹”æ€§éœ¸å‡Œçš„å—å®³è€…ã€‚`
          } else {
            finalMessage.innerHTML = `å³ä½¿æŸ¥çœ‹äº†å°è©±ï¼Œä½ ä»é¸æ“‡å°ç¦ã€‚<br><br>é€™å°±æ˜¯ç¤¾æœƒå£“åŠ›çš„åŠ›é‡â€”â€”247 å€‹æª¢èˆ‰ã€92% çš„æ•¸å­—ï¼Œéƒ½åœ¨æ¨å‹•ä½ åšå‡ºé€™å€‹é¸æ“‡ã€‚`
          }
        } else if (decision === 'info') {
          finalMessage.innerHTML = `ä½ é¸æ“‡ã€Œéœ€è¦æ›´å¤šè³‡è¨Šã€ã€‚<br><br>é€™æ˜¯è¬¹æ…çš„é¸æ“‡ã€‚ä½†åœ¨çœŸå¯¦å¹³å°ä¸Šï¼Œé€™å€‹é¸é …é€šå¸¸ä¸å­˜åœ¨â€”â€”ä½ åªèƒ½é¸ã€ŒåŒæ„å¤šæ•¸ã€æˆ–ã€Œè¢«è¦–ç‚ºå¹«å…‡ã€ã€‚`
        } else if (decision === 'dismiss') {
          finalMessage.innerHTML = `ä½ é¸æ“‡æ’¤éŠ·æª¢èˆ‰ã€‚<br><br>é€™éœ€è¦å‹‡æ°£â€”â€”å°æŠ— 247 äººæª¢èˆ‰å’Œ 92% çš„å£“åŠ›ã€‚ä½†åœ¨çœŸå¯¦ä¸–ç•Œä¸­ï¼Œåšå‡ºé€™å€‹é¸æ“‡çš„äººå¾€å¾€æœƒæˆç‚ºä¸‹ä¸€å€‹ç›®æ¨™ã€‚`
        }
      }

      showReveal()
    }

    function showReveal() {
      phaseCase?.classList.add('hidden')
      phaseReveal?.classList.remove('hidden')

      // Animate reveal items
      revealItems.forEach((item, index) => {
        setTimeout(
          () => {
            item.classList.remove('opacity-0', 'translate-y-2')
            item.classList.add('opacity-100', 'translate-y-0')
          },
          200 + index * 300,
        )
      })
    }

    function restart() {
      // Reset state
      startTime = Date.now()
      checkedContext = false
      decision = null
      reactionIndex = 0

      // Reset UI
      phaseReveal?.classList.add('hidden')
      phaseCase?.classList.remove('hidden')

      // Reset timer display
      if (timerValue) {
        timerValue.textContent = '0'
        timerValue.classList.remove('text-orange-500', 'text-red-500')
      }
      if (timerBar)
timerBar.style.width = '0%'

      // Reset context button
      if (contextBtn) {
        contextBtn.innerHTML = `<span class="text-xs">â–¶</span><span>æŸ¥çœ‹å®Œæ•´å°è©±ä¸²ï¼ˆ12 å‰‡ç•™è¨€ï¼‰</span>`
        contextBtn.classList.remove('text-green-600', 'dark:text-green-400')
        contextBtn.classList.add('text-stone-400')
      }

      // Reset reactions
      if (reactionsContainer) {
        reactionsContainer.innerHTML = ''
      }

      // Reset reveal items
      revealItems.forEach((item) => {
        item.classList.add('opacity-0', 'translate-y-2')
        item.classList.remove('opacity-100', 'translate-y-0')
      })

      // Reset reveal stats
      revealContext?.classList.remove('text-red-500', 'text-green-500')

      startTimer()
      startReactions()
    }

    // Event listeners
    decisionBtns.forEach((btn) => {
      btn.addEventListener('click', () => handleDecision(btn))
    })

    restartBtn?.addEventListener('click', restart)

    // Start
    startTimer()
    startReactions()

    // Cleanup
    const cleanup = () => {
      stopTimer()
      stopReactions()
    }
    document.addEventListener('swup:willReplaceContent', cleanup, { once: true })
  }

  // Initialize
  initScapegoatTrial()
  document.addEventListener('swup:contentReplaced', initScapegoatTrial)
  document.addEventListener('cardreader:open', initScapegoatTrial)
</script>

<style>
  .decision-btn {
    transition: all 0.15s ease;
  }

  .decision-btn:active {
    transform: scale(0.98);
  }
</style>
