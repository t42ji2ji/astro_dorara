---
import { themeConfig } from '~/.config'

interface Props {
  path: string
}

const twikooConfig = {
  ...themeConfig.comment?.twikoo,
  el: '#tcomment',
  path: Astro.props.path,
}
---

<div id="tcomment" data-twikoo-path={Astro.props.path}></div>
<script is:inline define:vars={{ twikooConfig }}>
  ;(function() {
    const TWIKOO_URL = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.32/dist/twikoo.all.min.js'

    // 使用全域變數追蹤狀態
    window.__twikooState = window.__twikooState || {
      observer: null,
      initialized: false,
      currentPath: null
    }
    const state = window.__twikooState

    function initTwikoo() {
      const container = document.getElementById('tcomment')
      if (!container || typeof twikoo === 'undefined') return

      const path = container.getAttribute('data-twikoo-path')

      // 如果已經初始化過相同的 path，跳過
      if (state.initialized && state.currentPath === path) {
        return
      }

      // 清空容器並重新初始化
      container.innerHTML = ''
      state.currentPath = path
      state.initialized = true

      twikoo.init({
        ...twikooConfig,
        el: '#tcomment',
        path: path
      })
    }

    function loadScript() {
      if (typeof twikoo !== 'undefined') {
        initTwikoo()
        return
      }

      const script = document.createElement('script')
      script.src = TWIKOO_URL
      script.onload = initTwikoo
      document.head.appendChild(script)
    }

    function setupObserver() {
      const container = document.getElementById('tcomment')
      if (!container) return

      // 重置初始化狀態（因為頁面已經變了）
      state.initialized = false

      // 清理舊的 observer
      if (state.observer) {
        state.observer.disconnect()
        state.observer = null
      }

      state.observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            state.observer.disconnect()
            state.observer = null
            loadScript()
          }
        })
      }, { rootMargin: '200px' })

      state.observer.observe(container)
    }

    // 初始載入
    setupObserver()

    // Swup 頁面轉換後重新設定（只註冊一次）
    if (!window.__twikooSwupRegistered) {
      window.__twikooSwupRegistered = true
      document.addEventListener('swup:contentReplaced', setupObserver)
    }
  })()
</script>
